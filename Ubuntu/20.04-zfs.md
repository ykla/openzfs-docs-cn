# 构建以 ZFS 为根文件系统的 Ubuntu 20.04

## 有更新的发行版可用

* 新安装请参阅[《Ubuntu 22.04 Root on ZFS》](https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2022.04%20Root%20on%20ZFS.html)。本教程已不再接收大多数更新，仅保留，用于参考此前按本指南完成的现有安装。

## 勘误

如果你之前使用本指南进行了安装，请在适用的情况下应用以下修复：

### `/boot/grub` 未挂载

**严重程度：** 普通（此前为严重）

**修复时间：** 2020 - 12 - 05（此前为 2020 - 05 - 30）

对于 mirror 或 raidz 拓扑，`/boot/grub` 位于单独的数据集上。最初为 `bpool/grub`，随后在 2020 - 05 - 30 更改为 `bpool/BOOT/ubuntu_UUID/grub`，以规避 zsys 将 `canmount=off` 导致 `/boot/grub` 无法挂载的问题。该变通方案又引发了快照恢复相关问题：[https://github.com/openzfs/openzfs-docs/issues/55](https://github.com/openzfs/openzfs-docs/issues/55) 。底层的 zsys 问题：[https://github.com/ubuntu/zsys/issues/164](https://github.com/ubuntu/zsys/issues/164) 已被修复并回移植到 20.04，因此现在又恢复为 `bpool/grub`。

* 如果你从未应用过 2020 - 05 - 30 的勘误修复，那么 `/boot/grub` 很可能没有挂载。请检查：

  ```sh
  mount | grep /boot/grub
  ```

  如果已挂载，则一切正常，停止即可。否则执行：

  ```sh
  zfs set canmount=on bpool/grub
  update-initramfs -c -k all
  update-grub

  grub-install --target=x86_64-efi --efi-directory=/boot/efi \
      --bootloader-id=ubuntu --recheck --no-floppy
  ```

  对于额外磁盘，请重复以下操作，将“2”递增为“3”等，对 `/boot/efi2` 与 `ubuntu-2` 同步递增：

  ```sh
  cp -a /boot/efi/EFI /boot/efi2
  grub-install --target=x86_64-efi --efi-directory=/boot/efi2 \
      --bootloader-id=ubuntu-2 --recheck --no-floppy
  ```

  检查以下文件是否包含 `set prefix=($root)'/grub@'`：

  ```sh
  grep prefix= \
      /boot/efi/EFI/ubuntu/grub.cfg \
      /boot/efi2/EFI/ubuntu-2/grub.cfg
  ```

* 如果你已经应用过 2020 - 05 - 30 的勘误修复，则需要回退数据集重命名：

  ```sh
  umount /boot/grub
  zfs rename bpool/BOOT/ubuntu_UUID/grub bpool/grub
  zfs set com.ubuntu.zsys:bootfs=no bpool/grub
  zfs mount bpool/grub
  ```

### AccountsService 未挂载

**严重程度：** 普通

**修复时间：** 2020 - 05 - 28

此前的教程在 `AccountsService`（`Accounts` 为复数）上存在拼写错误，写成了 `AccountServices`（`Services` 为复数）。这会导致 AccountsService 数据被写入根文件系统。仅在回滚根文件系统而未同时回滚用户数据时才会造成问题。请检查：

```sh
zfs list | grep Account
```

如果在“Accounts”上有“s” ，则正常；如果“s”在“Services”上，则按如下修复：

```sh
mv /var/lib/AccountsService /var/lib/AccountsService-old
zfs list -r rpool
# 将下方的 UUID 替换两次：
zfs rename rpool/ROOT/ubuntu_UUID/var/lib/AccountServices \
           rpool/ROOT/ubuntu_UUID/var/lib/AccountsService
mv /var/lib/AccountsService-old/* /var/lib/AccountsService
rmdir /var/lib/AccountsService-old
```

## 概述

### Ubuntu 安装器

Ubuntu 安装器已经支持 root-on-ZFS：[https://arstechnica.com/gadgets/2020/03/ubuntu-20-04s-zsys-adds-zfs-snapshots-to-package-management/](https://arstechnica.com/gadgets/2020/03/ubuntu-20-04s-zsys-adds-zfs-snapshots-to-package-management/) 。由于双向协作：[https://ubuntu.com/blog/enhancing-our-zfs-support-on-ubuntu-19-10-an-introduction](https://ubuntu.com/blog/enhancing-our-zfs-support-on-ubuntu-19-10-an-introduction) ，本教程生成的结果与 Ubuntu 安装器几乎完全相同。

如果你需要单磁盘、未加密的桌面安装，请使用安装器。相比手动完成所有步骤，这要容易且快速得多。

如果你需要 ZFS 原生加密的桌面安装，你可以对安装器进行简单修改：[https://linsomniac.gitlab.io/post/2020-04-09-ubuntu-2004-encrypted-zfs/](https://linsomniac.gitlab.io/post/2020-04-09-ubuntu-2004-encrypted-zfs/) 。其中的 `-O recordsize=1M` 与加密无关；除非你理解其含义，否则请省略。请务必使用至少 8 个字符的密码，否则该修改会导致安装器崩溃。此外，系统安装完成后，你应切换为加密的 swap：

```sh
swapon -v
# 记录设备，包括分区。

ls -l /dev/disk/by-id/
# 找到磁盘的 by-id 名称。

sudo swapoff -a
sudo vi /etc/fstab
# 移除 swap 条目。

sudo apt install --yes cryptsetup

# 根据上面的信息替换 DISK-partN：
echo swap /dev/disk/by-id/DISK-partN /dev/urandom \
    swap,cipher=aes-xts-plain64:sha256,size=512 | sudo tee -a /etc/crypttab
echo /dev/mapper/swap none swap defaults 0 0 | sudo tee -a /etc/fstab
```

希望安装器未来能获得加密支持：[https://bugs.launchpad.net/ubuntu/+source/ubiquity/+bug/1857398](https://bugs.launchpad.net/ubuntu/+source/ubiquity/+bug/1857398) 。

如果你需要设置 mirror 或 raidz 拓扑，使用 LUKS 加密，和/或安装服务器（无桌面 GUI），请使用本 HOWTO。

### 树莓派

如果你希望在树莓派上进行安装，请参阅 [Ubuntu 20.04 Root on ZFS for Raspberry Pi](https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2020.04%20Root%20on%20ZFS%20for%20Raspberry%20Pi.html)。

### 注意事项

* 本教程使用整个物理磁盘。
* 不要将这些说明用于双启动。
* 请备份你的数据。任何现有数据都会被清除。

### 系统需求

* [Ubuntu 20.04.4（“Focal”）Desktop CD](https://releases.ubuntu.com/20.04/ubuntu-20.04.4-desktop-amd64.iso)（不是任何 server 镜像）
* 安装到提供 4 KiB 逻辑扇区（“4Kn”）的磁盘上只能使用 UEFI 启动。这并非 ZFS 独有的问题。[GRUB 在 4Kn 磁盘上无法也不会支持 legacy（BIOS）启动。](http://savannah.gnu.org/bugs/?46700)

在内存少于 2 GiB 的计算机上运行 ZFS 存在严重瓶颈。对于基本工作负载，建议使用 4 GiB 内存以获得正常性能。如果你希望使用去重（deduplication），则需要 [大量的内存](http://wiki.freebsd.org/ZFSTuningGuide#Deduplication)。启用去重是一项永久性更改，无法轻易撤销。

### 支持

如果你需要帮助，请通过 [邮件列表](https://openzfs.github.io/openzfs-docs/Project%20and%20Community/Mailing%20Lists.html#mailing-lists) 或在 [Libera Chat](https://libera.chat/) 上的 IRC 频道 [#zfsonlinux](ircs://irc.libera.chat/#zfsonlinux) 联系社区。如果你有与本教程相关的 Bug 报告或功能请求，请 [提交一个新的 issue 并 @rlaager](https://github.com/openzfs/openzfs-docs/issues/new?body=@rlaager,%20I%20have%20the%20following%20issue%20with%20the%20Ubuntu%2020.04%20Root%20on%20ZFS%20HOWTO:)。

### 贡献

1. 复刻并克隆：[https://github.com/openzfs/openzfs-docs](https://github.com/openzfs/openzfs-docs)
2. 安装工具：

   ```sh
   sudo apt install python3-pip

   pip3 install -r docs/requirements.txt

   # 将 ~/.local/bin 添加到你的 $PATH，例如通过把下面内容加入 ~/.bashrc：
   PATH=$HOME/.local/bin:$PATH
   ```

3. 进行你的修改。
4. 测试：

   ```sh
   cd docs
   make html
   sensible-browser _build/html/index.html
   ```

5. 使用 `git commit --signoff` 提交到一个分支，`git push`，并创建一个 pull request。提及 @rlaager。


### 加密

本指南支持三种加密方案：未加密、ZFS 原生加密以及 LUKS。无论选择哪种方式，所有 ZFS 功能都可完全使用。

未加密选项当然不会对任何数据进行加密。由于没有加密开销，这种方式的性能自然最佳。

ZFS 原生加密会加密根池中的数据及大部分元数据，但不会加密数据集或快照的名称及属性。启动池（bpool）不会加密，它只包含引导加载程序、内核和 initrd。（除非你在 `/etc/fstab` 中设置了密码，否则 initrd 通常不包含敏感数据。）系统在启动时必须在控制台输入口令才能启动。性能表现良好。由于加密在 ZFS 内部进行，即使使用多块磁盘（镜像或 raidz 拓扑），数据只需加密一次。

LUKS 会加密几乎所有内容。唯一未加密的数据是引导加载程序、内核和 initrd。系统在启动时必须在控制台输入口令才能启动。性能良好，但 LUKS 位于 ZFS 之下，因此如果使用多块磁盘（镜像或 raidz 拓扑），数据在每块磁盘上都必须加密一次。

## 第 1 步：准备安装环境

1. 启动 Ubuntu Live CD，选择“尝试 Ubuntu”。根据需要将系统连接到网络（例如连接 WiFi）。打开终端（按 Ctrl-Alt-T）。
2. 设置并更新软件源：

   ```sh
   sudo apt update
   ```

3. 可选：在 Live CD 环境中安装并启动 OpenSSH 服务器：
   如果你有第二台系统，通过 SSH 访问目标系统会很方便：

   ```sh
   passwd
   # 当前未设置密码。
   sudo apt install --yes openssh-server vim
   ```

   安装完整的 `vim` 包可以解决通过 SSH 使用 Live CD 环境自带的 `vim-tiny` 时可能出现的终端问题。

   >**提示：**
   >
   >你可以通过 `ip addr show scope global | grep inet` 查看 IP 地址，然后从主机通过 `ssh ubuntu@IP` 连接。

4. 禁用自动挂载：

   如果磁盘以前被使用过（分区位置相同），之前的文件系统（例如 ESP）可能会自动挂载，如果不禁用可能会干扰安装：

   ```sh
   gsettings set org.gnome.desktop.media-handling automount false
   ```

5. 切换为 root 用户：

   ```sh
   sudo -i
   ```

6. 在 Live CD 环境中安装 ZFS：

   ```sh
   apt install --yes debootstrap gdisk zfsutils-linux

   systemctl stop zed
   ```

## 第 2 步：磁盘格式化

1. 设置磁盘变量：

   ```ini
   DISK=/dev/disk/by-id/scsi-SATA_disk1
   ```

   使用 ZFS 时，始终使用长格式别名 `/dev/disk/by-id/*`。直接使用设备节点 `/dev/sd*` 可能会导致导入失败，尤其是在系统存在多个存储池时。

   **提示：**

   * `ls -la /dev/disk/by-id` 可以列出别名。
   * 你是在虚拟机中操作吗？如果虚拟磁盘在 `/dev/disk/by-id` 中缺失，KVM+virtio 下可以使用 `/dev/vda`；否则请参考 [故障排查](https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2020.04%20Root%20on%20ZFS.html#troubleshooting) 部分。
   * 如果使用镜像（mirror）或 RAIDZ 拓扑，请使用 `DISK1`、`DISK2` 等变量。
   * 在选择 boot 存储池大小时，要考虑使用情况。内核和 initrd 可能占用约 100M。如果保留多个内核并进行快照，boot 存储池空间可能不足，尤其是在需要重新生成 initramfs（每个约 85M）时。请根据实际需求为 boot pool 分配合适空间。
2. 如果你要重复使用磁盘，请根据需要清理它：
   确保 swap 分区未被使用：

```sh
swapoff --all
```

如果磁盘以前用于 MD 阵列：

```sh
apt install --yes mdadm

# 查看是否有一个或多个 MD 阵列处于激活状态：
cat /proc/mdstat
# 如果有，停止它们（根据需要替换 ``md0``）：
mdadm --stop /dev/md0

# 对于使用整个磁盘的阵列：
mdadm --zero-superblock --force $DISK
# 对于使用分区的阵列（例如本教程中的 swap 分区）：
mdadm --zero-superblock --force ${DISK}-part2
```

清除分区表：

```sh
sgdisk --zap-all $DISK
```

如果出现内核仍在使用旧分区表的提示，可以请求内核重新加载分区信息：

```sh
partprobe $DISK
```

如果新分区仍未显示，可以重启并重新开始（除了这一步可以跳过）。

3. 创建引导分区：

```sh
sgdisk     -n1:1M:+512M   -t1:EF00 $DISK

# 对于传统（BIOS）启动：
sgdisk -a1 -n5:24K:+1000K -t5:EF02 $DISK
```

>**注意：**
>
>虽然 Ubuntu 安装程序在传统（BIOS）启动时使用 MBR 标签，本教程对 UEFI 和传统（BIOS）启动都使用 GPT 分区标签。这比提供两个选项更简单，同时也提供向前兼容性（面向未来）。换句话说，对于传统（BIOS）启动，这将允许你将磁盘移动到未来的新系统/主板，而无需重建 pool（或从备份恢复数据）。ESP 在两种情况下都会创建，原因类似。此外，在单盘安装中，ESP 被用于 `/boot/grub`，如[下文讨论](https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2022.04%20Root%20on%20ZFS.html#boot-grub-esp)。

4. 创建 swap 分区：
   早期版本的教程将 swap 放在 zvol 上。[Ubuntu 不推荐这种配置，因为可能导致死锁](https://bugs.launchpad.net/ubuntu/+source/zfs-linux/+bug/1847628)，上游也有[相关 bug 报告](https://github.com/zfsonlinux/zfs/issues/7734)。
   将 swap 放在分区上意味着放弃 ZFS 校验和对 swap 的保护，但考虑到 ZFS 与 swap 可能出现的死锁，这是合理的权衡。如果你对此不介意，可以选择不启用 swap。

根据需要选择一种方案：

* 单盘安装：

```sh
sgdisk     -n2:0:+500M    -t2:8200 $DISK
```

* 镜像或 raidz 拓扑：

```sh
sgdisk     -n2:0:+500M    -t2:FD00 $DISK
```

根据需要调整 swap 大小。如果你希望启用休眠（仅适用于未加密安装），swap 分区必须至少与系统内存大小相同。

5. 创建 boot 存储池分区：

```sh
sgdisk     -n3:0:+2G      -t3:BE00 $DISK
```

Ubuntu 安装程序使用磁盘空间的 5%，最小 500 MiB，最大 2 GiB。[分配过小（500 MiB 可能太小）可能导致无法升级内核](https://medium.com/@andaag/how-i-moved-a-ext4-ubuntu-install-to-encrypted-zfs-62af1170d46c)。

6. 创建 root pool 分区：
   选择以下方案之一：

* 未加密或 ZFS 原生加密：

```sh
sgdisk     -n4:0:0        -t4:BF00 $DISK
```

* LUKS：

```sh
sgdisk     -n4:0:0        -t4:8309 $DISK
```

如果你要创建镜像或 raidz 拓扑，请对所有将参与存储池的磁盘重复上述分区命令。

7. 创建 boot 存储池：

```sh
zpool create \
    -o cachefile=/etc/zfs/zpool.cache \
    -o ashift=12 -o autotrim=on -d \
    -o feature@async_destroy=enabled \
    -o feature@bookmarks=enabled \
    -o feature@embedded_data=enabled \
    -o feature@empty_bpobj=enabled \
    -o feature@enabled_txg=enabled \
    -o feature@extensible_dataset=enabled \
    -o feature@filesystem_limits=enabled \
    -o feature@hole_birth=enabled \
    -o feature@large_blocks=enabled \
    -o feature@lz4_compress=enabled \
    -o feature@spacemap_histogram=enabled \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O devices=off -O normalization=formD -O relatime=on -O xattr=sa \
    -O mountpoint=/boot -R /mnt \
    bpool ${DISK}-part3
```

通常无需为 boot 存储池自定义选项。

GRUB 并不支持所有 zpool 特性。参考 `spa_feature_names` 在 [grub-core/fs/zfs/zfs.c](http://git.savannah.gnu.org/cgit/grub.git/tree/grub-core/fs/zfs/zfs.c#n276)。此步骤创建一个独立的 boot 存储池 `/boot`，其特性限制为 GRUB 支持的功能，从而能让 root 存储池使用任意特性。GRUB 以只读方式打开存储池，因此所有只读兼容特性都被视为“受支持”。

**提示：**

* 若创建镜像（mirror）拓扑，使用：

```sh
zpool create \
    ... \
    bpool mirror \
    /dev/disk/by-id/scsi-SATA_disk1-part3 \
    /dev/disk/by-id/scsi-SATA_disk2-part3
```

* 对于 raidz 拓扑，将上面命令中的 `mirror` 替换为 `raidz`、`raidz2` 或 `raidz3`，并列出额外磁盘的分区。
* boot pool 的名称不再是任意的。**必须**为 `bpool`。如果真的想重命名，请在 GRUB 安装后编辑 `/etc/grub.d/10_linux_zfs` 并运行 `update-grub`。

**功能说明：**

* `allocation_classes` 功能理论上可安全使用，但除非真的使用（例如 `special` vdev），否则没有必要启用。对于 boot pool，极少有人会用到此功能。如果想加快 boot pool 速度，将整个 pool 放在更快的磁盘上比作为 `special` vdev 更合理。
* `project_quota` 功能已测试，可安全使用。对于 boot pool，几乎不会有影响。
* `resilver_defer` 功能理论上安全，但由于 boot pool 足够小，通常无需使用。
* `spacemap_v2` 功能已测试，可安全使用。boot pool 较小，因此实际影响不大。
* 作为只读兼容特性，`userobj_accounting` 理论上兼容，但在实践中，GRUB 可能报“invalid dnode type”错误。无论如何，这个功能对 `/boot` 并不重要。

8. 创建 root 存储池：

选择以下一种方式：

* **未加密：**

```sh
zpool create \
    -o ashift=12 -o autotrim=on \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O dnodesize=auto -O normalization=formD -O relatime=on \
    -O xattr=sa -O mountpoint=/ -R /mnt \
    rpool ${DISK}-part4
```

* **ZFS 原生加密：**

```sh
zpool create \
    -o ashift=12 -o autotrim=on \
    -O encryption=aes-256-gcm \
    -O keylocation=prompt -O keyformat=passphrase \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O dnodesize=auto -O normalization=formD -O relatime=on \
    -O xattr=sa -O mountpoint=/ -R /mnt \
    rpool ${DISK}-part4
```

* **LUKS 加密：**

```sh
cryptsetup luksFormat -c aes-xts-plain64 -s 512 -h sha256 ${DISK}-part4
cryptsetup luksOpen ${DISK}-part4 luks1
zpool create \
    -o ashift=12 -o autotrim=on \
    -O acltype=posixacl -O canmount=off -O compression=lz4 \
    -O dnodesize=auto -O normalization=formD -O relatime=on \
    -O xattr=sa -O mountpoint=/ -R /mnt \
    rpool /dev/mapper/luks1
```

**说明：**

* 建议使用 `ashift=12`，因为许多硬盘虽然显示 512 B 逻辑扇区，但物理扇区为 4 KiB 或更大。未来更换硬盘时，如果物理扇区为 4 KiB（推荐 `ashift=12`）或逻辑扇区为 4 KiB（必须 `ashift=12`），都会受益。
* `-O acltype=posixacl` 全局启用 POSIX ACL。如果不想全局启用，可移除此选项，但在创建 `/var/log` 时仍需添加 `-o acltype=posixacl`（小写“o”），因为 [journald 依赖 ACL](https://askubuntu.com/questions/970886/journalctl-says-failed-to-search-journal-acl-operation-not-supported)。禁用 ACL 会破坏 NFSv4 的 umask 处理 [相关讨论](https://bugs.launchpad.net/ubuntu/+source/nfs-utils/+bug/1779736)。
* `normalization=formD` 消除了 UTF-8 文件名的一些极端情况，并隐含 `utf8only=on`，意味着只允许 UTF-8 文件名。如果希望支持非 UTF-8 文件名，请不要使用该选项。关于 UTF-8 强制使用的问题，参见 [The problems with enforced UTF-8 only filenames](http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames)。
* `recordsize` 保持默认 128 KiB。如果希望调整（例如 `-O recordsize=1M`），可参考 [文章 1](https://jrs-s.net/2019/04/03/on-zfs-recordsize/) [文章 2](http://blog.programster.org/zfs-record-size) [文章 3](https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSFileRecordsizeGrowth) [文章 4](https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSRecordsizeAndCompression)。
* `relatime=on` 是 `atime` 和 `atime=off` 之间的折中方案。Linux 2.6.30 之后，其他文件系统默认即为 `relatime`。[RedHat 文档](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/power_management_guide/relatime) 说明详情。
* `xattr=sa` [显著提升扩展属性性能](https://github.com/zfsonlinux/zfs/commit/82a37189aac955c81a59a5ecc3400475adb56355)。ZFS 内部使用扩展属性实现 POSIX ACL，用户空间应用也可能使用（部分 GUI 应用、Samba 存储 Windows ACL/DOS 属性、Samba AD DC 均依赖）。`xattr=sa` 为 Linux 特有，如果迁移到其他 OpenZFS 实现，扩展属性不可读，但数据仍可访问。如果对扩展属性可移植性有要求，可省略 `-O xattr=sa`，即使不全局使用，也推荐用于 `/var/log`。
* 必须在设备路径中包含 `-part4`，否则 ZFS 会误认为整个磁盘，可能重建分区并覆盖 bootloader 分区。
* ZFS 原生加密默认使用 `aes-256-ccm`，但上游已改为 `aes-256-gcm`，性能更好且未来更快。
* LUKS 密钥长度为 512 位，但 XTS 模式需要两个密钥，因此实际为 AES-256。
* 密码可能是最弱环节，请谨慎选择。参见 [cryptsetup FAQ 第 5 节](https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects) 获取建议。

**提示：**

* 如果创建镜像（mirror）拓扑，可使用如下命令创建 root pool：

  ```bash
  zpool create \
      ... \
      rpool mirror \
      /dev/disk/by-id/scsi-SATA_disk1-part4 \
      /dev/disk/by-id/scsi-SATA_disk2-part4
  ```

* 对于 raidz 拓扑，将上例中的 `mirror` 替换为 `raidz`、`raidz2` 或 `raidz3`，并列出所有参与的磁盘分区。
* 使用 LUKS 时，如果是镜像或 raidz 拓扑，需要使用 `/dev/mapper/luks1`、`/dev/mapper/luks2` 等路径，这些需先用 `cryptsetup` 创建。
* 名称可以自定义存储池名，但一旦修改，新名称必须在整个系统中保持一致。在支持自动安装到 ZFS 的系统中，默认的 root 存储池名称为 `rpool`。

## 第 3 步：系统安装

1. 创建作为容器的文件系统数据集：

   ```bash
   zfs create -o canmount=off -o mountpoint=none rpool/ROOT
   zfs create -o canmount=off -o mountpoint=none bpool/BOOT
   ```

2. 为 root 和 boot 文件系统创建文件系统数据集：

   ```bash
   UUID=$(dd if=/dev/urandom bs=1 count=100 2>/dev/null |
       tr -dc 'a-z0-9' | cut -c-6)

   zfs create -o mountpoint=/ \
       -o com.ubuntu.zsys:bootfs=yes \
       -o com.ubuntu.zsys:last-used=$(date +%s) rpool/ROOT/ubuntu_$UUID

   zfs create -o mountpoint=/boot bpool/BOOT/ubuntu_$UUID
   ```

3. 创建其他数据集：

   ```bash
   zfs create -o com.ubuntu.zsys:bootfs=no \
       rpool/ROOT/ubuntu_$UUID/srv
   zfs create -o com.ubuntu.zsys:bootfs=no -o canmount=off \
       rpool/ROOT/ubuntu_$UUID/usr
   zfs create rpool/ROOT/ubuntu_$UUID/usr/local
   zfs create -o com.ubuntu.zsys:bootfs=no -o canmount=off \
       rpool/ROOT/ubuntu_$UUID/var
   zfs create rpool/ROOT/ubuntu_$UUID/var/games
   zfs create rpool/ROOT/ubuntu_$UUID/var/lib
   zfs create rpool/ROOT/ubuntu_$UUID/var/lib/AccountsService
   zfs create rpool/ROOT/ubuntu_$UUID/var/lib/apt
   zfs create rpool/ROOT/ubuntu_$UUID/var/lib/dpkg
   zfs create rpool/ROOT/ubuntu_$UUID/var/lib/NetworkManager
   zfs create rpool/ROOT/ubuntu_$UUID/var/log
   zfs create rpool/ROOT/ubuntu_$UUID/var/mail
   zfs create rpool/ROOT/ubuntu_$UUID/var/snap
   zfs create rpool/ROOT/ubuntu_$UUID/var/spool
   zfs create rpool/ROOT/ubuntu_$UUID/var/www

   zfs create -o canmount=off -o mountpoint=/ \
       rpool/USERDATA
   zfs create -o com.ubuntu.zsys:bootfs-datasets=rpool/ROOT/ubuntu_$UUID \
       -o canmount=on -o mountpoint=/root \
       rpool/USERDATA/root_$UUID
   chmod 700 /mnt/root
   ```

   对于镜像或 raidz 拓扑，为 `/boot/grub` 创建 dataset：

   ```bash
   zfs create -o com.ubuntu.zsys:bootfs=no bpool/grub
   ```

   在 `/run` 挂载 tmpfs：

   ```bash
   mkdir /mnt/run
   mount -t tmpfs tmpfs /mnt/run
   mkdir /mnt/run/lock
   ```

   如果希望 `/tmp` 拥有单独的 dataset：

   ```bash
   zfs create -o com.ubuntu.zsys:bootfs=no \
       rpool/ROOT/ubuntu_$UUID/tmp
   chmod 1777 /mnt/tmp
   ```

   该布局的主要目标是将操作系统与用户数据分离。这样可以在不影响用户数据的情况下回滚 root 文件系统。如果不额外操作，`/tmp` 将存储在 root 文件系统中。也可创建独立 dataset，这样 `/tmp` 数据不会被 root 文件系统的快照包含，并且可以对 `rpool/tmp` 设置配额限制最大使用空间。否则，也可以 later 使用 tmpfs（RAM 文件系统）。

4. 安装最小系统：

   ```bash
   debootstrap focal /mnt
   ```

   `debootstrap` 会生成一个未配置的系统。另一种方法是将一个已工作的系统整体复制到新的 ZFS root。

5. 复制 `zpool.cache`：

   ```bash
   mkdir /mnt/etc/zfs
   cp /etc/zfs/zpool.cache /mnt/etc/zfs/
   ```

## 第 4 步：系统配置

1. 配置主机名：
   将 `主机名` 替换为所需主机名：

   ```bash
   hostname 主机名
   hostname > /mnt/etc/hostname
   vi /mnt/etc/hosts
   ```

   添加一行：

   ```ini
   127.0.1.1       HOSTNAME
   ```

   或者如果系统在 DNS 中有真实域名：

   ```ini
   127.0.1.1       FQDN HOSTNAME
   ```

   >**提示：**
   >
   >如果不熟悉 `vi`，可以使用 `nano`。

2. 配置网络接口：
   查找接口名称：

   ```bash
   ip addr show
   ```

   将下面 `NAME` 替换为你的接口名：

   ```bash
   vi /mnt/etc/netplan/01-netcfg.yaml
   ```

   内容示例：

   ```yaml
   network:
     version: 2
     ethernets:
       NAME:
         dhcp4: true
   ```

   如果系统不是 DHCP 客户端，请根据实际情况修改此文件。

3. 配置软件源：

   ```bash
   vi /mnt/etc/apt/sources.list
   ```

   添加以下内容：

   ```ini
   deb http://archive.ubuntu.com/ubuntu focal main restricted universe multiverse
   deb http://archive.ubuntu.com/ubuntu focal-updates main restricted universe multiverse
   deb http://archive.ubuntu.com/ubuntu focal-backports main restricted universe multiverse
   deb http://security.ubuntu.com/ubuntu focal-security main restricted universe multiverse
   ```

4. 将 LiveCD 环境的虚拟文件系统绑定到新系统并 `chroot`：

   ```bash
   mount --make-private --rbind /dev  /mnt/dev
   mount --make-private --rbind /proc /mnt/proc
   mount --make-private --rbind /sys  /mnt/sys
   chroot /mnt /usr/bin/env DISK=$DISK UUID=$UUID bash --login
   ```

   **注意：** 这里使用 `--rbind` 而不是 `--bind`。

5. 配置基本系统环境：

   ```bash
   apt update
   ```

   即使偏好非英语系统语言，也确保 `en_US.UTF-8` 可用：

   ```bash
   dpkg-reconfigure locales tzdata keyboard-configuration console-setup
   ```

   安装文本编辑器：

   ```bash
   apt install --yes nano
   apt install --yes vim
   ```

   安装完整 `vim` 包可以解决通过 SSH 使用 `vim-tiny` 时的终端问题。

6. 仅对 LUKS 安装，设置 `/etc/crypttab`：

   ```bash
   apt install --yes cryptsetup

   echo luks1 /dev/disk/by-uuid/$(blkid -s UUID -o value ${DISK}-part4) \
       none luks,discard,initramfs > /etc/crypttab
   ```

   `initramfs` 是为了解决 [cryptsetup 不支持 ZFS 的问题](https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906)。
   **提示：** 如果是镜像或 raidz 拓扑，请为 `luks2` 等磁盘重复添加 `/etc/crypttab` 条目。

7. 创建 EFI 文件系统（适用于 UEFI 和 legacy BIOS 启动）：

   ```bash
   apt install --yes dosfstools

   mkdosfs -F 32 -s 1 -n EFI ${DISK}-part1
   mkdir /boot/efi
   echo /dev/disk/by-uuid/$(blkid -s UUID -o value ${DISK}-part1) \
       /boot/efi vfat defaults 0 0 >> /etc/fstab
   mount /boot/efi
   ```

   对于镜像或 raidz 拓扑，为其他磁盘重复 `mkdosfs`，但不要重复其它命令。
   **注意：** `-s 1` 仅对 4Kn 盘需要，以满足 FAT32 最小簇大小要求。512B 盘可正常工作。

8. 将 `/boot/grub` 放到 EFI 系统分区（仅单盘安装）：

   ```bash
   mkdir /boot/efi/grub /boot/grub
   echo /boot/efi/grub /boot/grub none defaults,bind 0 0 >> /etc/fstab
   mount /boot/grub
   ```

   这样 GRUB 可以写入 `/boot/grub`，使 `/boot/grub/grubenv` 和 `recordfail` 功能正常。对于镜像或 raidz 拓扑，`/boot/grub` 保留在 boot pool，以保证镜像/raidz 行为正确，但无法写入 `grubenv`。

9. 在 chroot 环境安装 GRUB/Linux/ZFS：

   * legacy BIOS 启动：

     ```bash
     apt install --yes grub-pc linux-image-generic zfs-initramfs zsys
     ```

     使用空格键选择池中的所有磁盘（非分区）。

   * UEFI 启动：

     ```bash
     apt install --yes \
         grub-efi-amd64 grub-efi-amd64-signed linux-image-generic \
         shim-signed zfs-initramfs zsys
     ```

   **注意：**

   * 忽略 `ERROR: Couldn't resolve device` 和 `WARNING: Couldn't determine root device` 错误。原因同上。
   * 忽略 `Module zfs not found` 和 `couldn't connect to zsys daemon` 错误。
   * 镜像或 raidz 拓扑，此步骤只在第一块磁盘安装 GRUB，其余磁盘稍后处理。

10. 可选：移除 os-prober：

    ```bash
    apt purge --yes os-prober
    ```

    避免 `update-grub` 错误。os-prober 仅在双系统中必要。

11. 设置 root 密码：

    ```bash
    passwd
    ```

12. 配置 swap：
    选择对应情况执行：

    * 单盘未加密：

      ```bash
      mkswap -f ${DISK}-part2
      echo /dev/disk/by-uuid/$(blkid -s UUID -o value ${DISK}-part2) \
          none swap discard 0 0 >> /etc/fstab
      swapon -a
      ```

    * 镜像/raidz 未加密：

      ```bash
      apt install --yes mdadm
      mdadm --create /dev/md0 --metadata=1.2 --level=mirror \
          --raid-devices=2 ${DISK1}-part2 ${DISK2}-part2
      mkswap -f /dev/md0
      echo /dev/disk/by-uuid/$(blkid -s UUID -o value /dev/md0) \
          none swap discard 0 0 >> /etc/fstab
      ```

    * 单盘加密（LUKS 或 ZFS 原生加密）：

      ```bash
      apt install --yes cryptsetup

      echo swap ${DISK}-part2 /dev/urandom \
            swap,cipher=aes-xts-plain64:sha256,size=512 >> /etc/crypttab
      echo /dev/mapper/swap none swap defaults 0 0 >> /etc/fstab
      ```

    * 镜像/raidz 加密：

      ```bash
      apt install --yes cryptsetup mdadm

      mdadm --create /dev/md0 --metadata=1.2 --level=mirror \
          --raid-devices=2 ${DISK1}-part2 ${DISK2}-part2
      echo swap /dev/md0 /dev/urandom \
            swap,cipher=aes-xts-plain64:sha256,size=512 >> /etc/crypttab
      echo /dev/mapper/swap none swap defaults 0 0 >> /etc/fstab
      ```

13. 可选（推荐）：将 `/tmp` 挂载到 tmpfs
    如果之前创建了 `/tmp` dataset，则跳过。否则：

    ```bash
    cp /usr/share/systemd/tmp.mount /etc/systemd/system/
    systemctl enable tmp.mount
    ```

14. 配置系统用户组：

    ```bash
    addgroup --system lpadmin
    addgroup --system lxd
    addgroup --system sambashare
    ```

15. 修复依赖循环（针对 ZFS 原生加密或 LUKS）：

    ```bash
    apt install --yes curl patch

    curl https://launchpadlibrarian.net/478315221/2150-fix-systemd-dependency-loops.patch | \
        sed "s|/etc|/lib|;s|\.in$||" | (cd / ; patch -p1)
    ```

    忽略 Hunk #2 的失败（回答 `n` 两次）。

    来源：[Bug #1875577 Encrypted swap won’t load on 20.04 with zfs root](https://bugs.launchpad.net/ubuntu/+source/zfs-linux/+bug/1875577)。

16. 可选：安装 SSH：

    ```bash
    apt install --yes openssh-server

    vi /etc/ssh/sshd_config
    # 设置：PermitRootLogin yes
    ```

## 第 5 步：GRUB 安装

1. 验证 ZFS 启动文件系统是否被识别：

   ```bash
   grub-probe /boot
   ```

2. 刷新 initrd 文件：

   ```bash
   update-initramfs -c -k all
   ```

   >**注意：**
   >
   >忽略 `ERROR: Couldn't resolve device` 和 `WARNING: Couldn't determine root device` 错误。[cryptsetup 不支持 ZFS](https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906)。

3. 禁用内存清零：

   ```bash
   vi /etc/default/grub
   # 在 GRUB_CMDLINE_LINUX_DEFAULT 中添加：init_on_alloc=0
   # 保存并退出
   ```

   此操作用于解决 [性能回退问题](https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1862822)。

4. 可选（强烈推荐）：便于调试 GRUB：

   ```bash
   vi /etc/default/grub
   # 注释掉：GRUB_TIMEOUT_STYLE=hidden
   # 设置：GRUB_TIMEOUT=5
   # 在 GRUB_TIMEOUT 下方添加：GRUB_RECORDFAIL_TIMEOUT=5
   # 从 GRUB_CMDLINE_LINUX_DEFAULT 中删除 quiet 和 splash
   # 取消注释：GRUB_TERMINAL=console
   # 保存并退出
   ```

   系统重启两次确认正常后，可以恢复这些修改。

5. 更新启动配置：

   ```bash
   update-grub
   ```

   **注意：** 如出现 os-prober 错误，可忽略。

6. 安装引导加载程序：

   * legacy BIOS 启动，将 GRUB 安装到 MBR：

     ```bash
     grub-install $DISK
     ```

     注意是安装到整块磁盘，而非分区。若为镜像或 raidz 拓扑，请对池中的每块磁盘重复执行。

   * UEFI 启动，将 GRUB 安装到 ESP：

     ```bash
     grub-install --target=x86_64-efi --efi-directory=/boot/efi \
         --bootloader-id=ubuntu --recheck --no-floppy
     ```

7. 禁用 grub-initrd-fallback.service（镜像或 raidz 拓扑）：

   ```bash
   systemctl mask grub-initrd-fallback.service
   ```

   该服务用于 `/boot/grub/grubenv`，在镜像或 raidz 中不工作。禁用可防止挂载 `/boot/grub` 失败时阻塞。
   另一种方法是通过 drop-in 单元设置 `RequiresMountsFor=/boot/grub`，但这里不必额外操作。[相关 Bug](https://bugs.launchpad.net/ubuntu/+source/grub2/+bug/1881442)

8. 修复文件系统挂载顺序：
   激活 `zfs-mount-generator`，使 systemd 识别独立挂载点，这对于 `/var/log` 和 `/var/tmp` 等很重要。`rsyslog.service` 依赖 `var-log.mount`，使用 `PrivateTmp` 的服务自动依赖 `var-tmp.mount`。

   ```bash
   mkdir /etc/zfs/zfs-list.cache
   touch /etc/zfs/zfs-list.cache/bpool
   touch /etc/zfs/zfs-list.cache/rpool
   ln -s /usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh /etc/zfs/zed.d
   zed -F &
   ```

   验证缓存已更新：

   ```bash
   cat /etc/zfs/zfs-list.cache/bpool
   cat /etc/zfs/zfs-list.cache/rpool
   ```

   如果为空，强制更新：

   ```bash
   zfs set canmount=on bpool/BOOT/ubuntu_$UUID
   zfs set canmount=on rpool/ROOT/ubuntu_$UUID
   ```

   若仍为空，停止 zed（`fg` 后 Ctrl-C），重新启动 zed 再试。

   数据写入后，停止 `zed`：

   ```bash
   fg
   Ctrl-C
   ```

   修正路径，去掉 `/mnt`：

   ```bash
   sed -Ei "s|/mnt/?|/|" /etc/zfs/zfs-list.cache/*
   ```

9. 退出 `chroot` 回到 LiveCD 环境：

   ```bash
   exit
   ```

10. 在 LiveCD 环境卸载所有文件系统：

    ```bash
    mount | grep -v zfs | tac | awk '/\/mnt/ {print $3}' | \
        xargs -i{} umount -lf {}
    zpool export -a
    ```

11. 重启系统：

    ```bash
    reboot
    ```

    等待新系统正常启动并以 root 登录。

## 第 6 步：首次启动

1. 将 GRUB 安装到附加磁盘：

   仅适用于 UEFI 镜像或 raidz 拓扑：

   ```sh
   dpkg-reconfigure grub-efi-amd64

   使用空格键选择所有 ESP 分区（每个池磁盘的分区 1）。
   ```

2. 创建用户账户：
   将 `你的用户名` 替换为你希望使用的用户名：

   ```sh
   username=你的用户名

   UUID=$(dd if=/dev/urandom bs=1 count=100 2>/dev/null |
       tr -dc 'a-z0-9' | cut -c-6)
   ROOT_DS=$(zfs list -o name | awk '/ROOT\/ubuntu_/{print $1;exit}')
   zfs create -o com.ubuntu.zsys:bootfs-datasets=$ROOT_DS \
       -o canmount=on -o mountpoint=/home/$username \
       rpool/USERDATA/${username}_$UUID
   adduser $username

   cp -a /etc/skel/. /home/$username
   chown -R $username:$username /home/$username
   usermod -a -G adm,cdrom,dip,lpadmin,lxd,plugdev,sambashare,sudo $username
   ```

## 第 7 步：完整软件安装

1. 升级最小系统：

   ```sh
   apt dist-upgrade --yes
   ```

2. 安装常规软件集：

   选择以下方案之一：

   * 仅安装命令行环境：

     ```sh
     apt install --yes ubuntu-standard
     ```

   * 安装完整 GUI 环境：

     ```sh
     apt install --yes ubuntu-desktop
     ```

     >**提示**：
     >
     >如果安装完整 GUI 环境，通常希望使用 NetworkManager 管理网络：

     ```sh
     rm /etc/netplan/01-netcfg.yaml
     vi /etc/netplan/01-network-manager-all.yaml
     ```

     ```yaml
     network:
       version: 2
       renderer: NetworkManager
     ```

3. 可选：禁用日志压缩

   由于 `/var/log` 已被 ZFS 压缩，logrotate 的压缩会消耗 CPU 和磁盘 I/O，但收益通常很小。此外，如果你对 `/var/log` 做快照，logrotate 的压缩反而浪费空间，因为未压缩的数据仍会存在于快照中。可以手动编辑 `/etc/logrotate.d` 下的文件，将 `compress` 注释掉，或使用以下循环（强烈建议复制粘贴）：

   ```sh
   for file in /etc/logrotate.d/* ; do
       if grep -Eq "(^|[^#y])compress" "$file" ; then
           sed -i -r "s/(^|[^#y])(compress)/\1#\2/" "$file"
       fi
   done
   ```

4. 重启：

   ```sh
   reboot
   ```

## 第 8 步：最终清理

1. 等待系统正常启动。使用你创建的账户登录，确保系统（包括网络）运行正常。

2. 可选：禁用 root 密码：

   ```sh
   sudo usermod -p '*' root
   ```

3. 可选（强烈建议）：禁用 root SSH 登录

   如果之前安装过 SSH，撤销临时更改：

   ```sh
   sudo vi /etc/ssh/sshd_config
   # 删除：PermitRootLogin yes

   sudo systemctl restart ssh
   ```

4. 可选：重新启用图形化启动

   如果你希望使用图形化启动，现在可以重新启用。使用 LUKS 时，提示界面会更美观。

   ```sh
   sudo vi /etc/default/grub
   # 取消注释：GRUB_TIMEOUT_STYLE=hidden
   # 在 GRUB_CMDLINE_LINUX_DEFAULT 中添加 quiet 和 splash
   # 注释掉：GRUB_TERMINAL=console
   # 保存并退出。

   sudo update-grub
   ```

   **注意：** 如出现 `osprober` 错误，可忽略。

5. 可选：仅针对 LUKS 安装，备份 LUKS 头：

   ```sh
   sudo cryptsetup luksHeaderBackup /dev/disk/by-id/scsi-SATA_disk1-part4 \
       --header-backup-file luks1-header.dat
   ```

   将备份存放在安全位置（例如云存储）。它受 LUKS 密码保护，但你也可以使用额外加密。

   >**提示：**
   >
   >如果创建了镜像或 raidz 拓扑，请对每个 LUKS 卷重复此操作（如 `luks2` 等）。

## 故障排除

### 使用 Live CD 救援

参照 [第 1 步：准备安装环境](https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2020.04%20Root%20on%20ZFS.html#step-1-prepare-the-install-environment)。

对于 LUKS，首先解锁磁盘：

```sh
cryptsetup luksOpen /dev/disk/by-id/scsi-SATA_disk1-part4 luks1
# 如果是镜像或 raidz 拓扑，请对其他磁盘重复此操作。
```

正确挂载所有数据集：

```sh
zpool export -a
zpool import -N -R /mnt rpool
zpool import -N -R /mnt bpool
zfs load-key -a
# 根据需要替换“UUID”；使用 zfs list 查找：
zfs mount rpool/ROOT/ubuntu_UUID
zfs mount bpool/BOOT/ubuntu_UUID
zfs mount -a
```

如有必要，可以 chroot 进入已安装环境：

```sh
mount --make-private --rbind /dev  /mnt/dev
mount --make-private --rbind /proc /mnt/proc
mount --make-private --rbind /sys  /mnt/sys
mount -t tmpfs tmpfs /mnt/run
mkdir /mnt/run/lock
chroot /mnt /bin/bash --login
mount -a
```

执行你需要的操作以修复系统。

完成后，进行清理：

```sh
exit
mount | grep -v zfs | tac | awk '/\/mnt/ {print $3}' | \
    xargs -i{} umount -lf {}
zpool export -a
reboot
```

### Areca

需要 `arcsas` blob 驱动的系统应将其添加到 `/etc/initramfs-tools/modules` 文件中，并运行 `update-initramfs -c -k all`。

如果内核日志中出现类似 `RIP: 0010:[<ffffffff8101b316>]  [<ffffffff8101b316>] native_read_tsc+0x6/0x20` 的信息，请升级或降级 Areca 驱动。ZoL 在出现此错误信息的系统上不稳定。

### MPT2SAS

本教程的大多数问题报告涉及异步初始化驱动缓慢的 `mpt2sas` 硬件，例如某些 IBM M1015 或刷成参考 LSI 固件的 OEM 卡。

基本问题是，这些控制器上的磁盘在常规系统启动之前对 Linux 内核不可见，而 ZoL 不会热插拔池成员。见 [https://github.com/zfsonlinux/zfs/issues/330](https://github.com/zfsonlinux/zfs/issues/330)。

大多数 LSI 卡与 ZoL 完全兼容。如果你的 LSI 卡存在此问题，请尝试在 `/etc/default/zfs` 中设置 `ZFS_INITRD_PRE_MOUNTROOT_SLEEP=X`。系统将在导入池之前等待 X 秒以确保所有磁盘可用。

### QEMU/KVM/XEN

使用 libvirt 或 qemu 为每个虚拟磁盘设置唯一序列号（例如 `-drive if=none,id=disk1,file=disk1.qcow2,serial=1234567890`）。

如需在虚拟机中使用 UEFI（而非仅 BIOS 启动），在主机上执行：

```sh
sudo apt install ovmf
sudo vi /etc/libvirt/qemu.conf
```

取消对以下行的注释：

```ini
nvram = [
   "/usr/share/OVMF/OVMF_CODE.fd:/usr/share/OVMF/OVMF_VARS.fd",
   "/usr/share/OVMF/OVMF_CODE.secboot.fd:/usr/share/OVMF/OVMF_VARS.fd",
   "/usr/share/AAVMF/AAVMF_CODE.fd:/usr/share/AAVMF/AAVMF_VARS.fd",
   "/usr/share/AAVMF/AAVMF32_CODE.fd:/usr/share/AAVMF/AAVMF32_VARS.fd",
   "/usr/share/OVMF/OVMF_CODE.ms.fd:/usr/share/OVMF/OVMF_VARS.ms.fd"
]
```

```sh
sudo systemctl restart libvirtd.service
```

### VMware

* 在 vmx 文件或 vSphere 配置中设置 `disk.EnableUUID = "TRUE"`。这样可以确保在虚拟机中创建别名 `/dev/disk`。

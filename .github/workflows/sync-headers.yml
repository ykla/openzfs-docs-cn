name: ðŸ”— ä»Ž SUMMARY.md æ›´æ–°ä¸€çº§æ ‡é¢˜

on:
  push:
  workflow_run:
    workflows: [ðŸ”— ä»Ž SUMMARY.md æ›´æ–°ç›®å½•]
    types:
      - completed
  workflow_dispatch:

jobs:
  verify-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Sync headers
        id: sync
        run: |
          export LC_ALL=C.UTF-8
          CHANGED="false"

          # è¯»å– SUMMARY.md ä¸­çš„ Markdown é“¾æŽ¥
          while IFS= read -r line; do
            # ä½¿ç”¨æ­£åˆ™æå–æ ‡é¢˜å’Œè·¯å¾„ï¼Œå…è®¸ç©ºæ ¼
            if [[ $line =~ \*\ *\[(.+)\]\((.+)\) ]]; then
              title="${BASH_REMATCH[1]}"
              path="${BASH_REMATCH[2]}"

              # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨åˆ™è·³è¿‡
              [ ! -f "$path" ] && continue

              # èŽ·å–æ–‡ä»¶ç¬¬ä¸€è¡Œå¹¶æ¸…ç†æ ¼å¼
              first_line=$(head -n 1 "$path" | sed 's/^#*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
              clean_title=$(echo "$title" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')

              # æ¯”è¾ƒå¹¶æ›´æ–°
              if [ "$first_line" != "$clean_title" ]; then
                echo "Updating $path: '$first_line' -> '$clean_title'"
                temp_file=$(mktemp)
                echo "# $clean_title" > "$temp_file"
                tail -n +2 "$path" >> "$temp_file"
                mv -f "$temp_file" "$path"
                git add "$path"
                CHANGED="true"
              fi
            fi
          done < SUMMARY.md

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.sync.outputs.changed == 'true'
        run: |
          git config --global user.name "ykla"
          git config --global user.email "yklaxds@gmail.com"
          git commit -m "chore: sync headers with SUMMARY.md"
          git push
